<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
</head>
<body>
</body>
</html>

<script type="module">
import APIUtil from "../src/APIUtil.js";
import storage from "../src/storage.js";

const login_url = new URL("./login.html", location);
const redirect_uri = new URL("./oauth.html", location);

const search = new URL(document.location).searchParams;
const mastodon_url = search.get("mastodon_url");
const code = search.get("code");

(async ()=> {

  if (mastodon_url) {
    redirect_uri.searchParams.set("mastodon_url", mastodon_url);

    const servers = storage.get("servers") || [];
    let server = servers.find((server)=> server.mastodon_url === mastodon_url);
    if (!server) {
      const {client_id, client_secret} = await APIUtil.url(mastodon_url)
      .app({
        client_name: "test",
        scopes: "read write follow",
        redirect_uris: redirect_uri,
        website: "",
      });
      server = {mastodon_url, client_id, client_secret};
      storage.set("servers", [server, ...servers]);
    }

    if (code && server) {
      let {access_token} = await APIUtil.url(server.mastodon_url)
      .token({
        client_id: server.client_id,
        client_secret: server.client_secret,
        code,
        redirect_uri,
      });
      login_url.searchParams.set("mastodon_url", server.mastodon_url);
      login_url.searchParams.set("access_token", access_token);
      location.replace(login_url);
    }

    else if (server) {
      let authLink = APIUtil.url(server.mastodon_url)
      .authLink({
        scope: "read write follow",
        redirect_uri,
        client_id: server.client_id,
      });
      location.replace(authLink);
    }
  }

})();
</script>