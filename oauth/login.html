<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>mastodon-api-test</title>
    <script src="../node_modules/dev-kit/dist/dev-kit.js"></script>
  </head>
  <body>
    <dev-kit></dev-kit>
    <div class="main"></div>
  </body>
</html>

<script type="module">
import {h, app} from "../src/hyperapp.js";

const main_url = new URL("../index.html", location);
const oauth_url = new URL("./oauth.html", location);

const search = new URL(document.location).searchParams;
const [mastodon_url, access_token] = [search.get("mastodon_url"), search.get("access_token")];
if (mastodon_url, access_token) {
  main_url.searchParams.set("mastodon_url", mastodon_url);
  main_url.searchParams.set("access_token", access_token);
  location.href = main_url;
}


const state = {
  url: "",
  no_token: false,
}

const action = {
  onNoTokenToggleClick: ({target: {checked}})=> ({no_token: checked}),
  onUrlFieldInput: ({target: {value}})=> ({url: value}),
  onUrlFieldkeyDown: ({keyCode})=> keyCode === 13 ? action.submit() : null,
  onSubmitButtonClick: ()=> action.submit(),

  submit: ()=> (state)=> {
    state.url
    ? state.no_token
      ? location.href = main_url + `?mastodon_url=${state.url}`
      : location.href = oauth_url + `?mastodon_url=${state.url}`
    : null;
  },
}

const view = (state, action)=>
  h("div", {class: "login"}, [
    h("label", {class: "login__no-token"},
      "アカウントを使わない",
      h("input", {
        type: "checkbox",
        onclick: (ev)=> action.onNoTokenToggleClick(ev),
      }),
    ),
    h("label", {class: "login__url"},
      h("input", {
        type: "text",
        placeholder: "https://example.com",
        oninput: (ev)=> action.onUrlFieldInput(ev),
        onkeydown: (ev)=> action.onUrlFieldkeyDown(ev),
      }),
    ),
    h("label", {class: "login__submit"},
      "ログイン",
      h("button", {
        onclick: ()=> action.onSubmitButtonClick(),
      }),
    ),
  ])

let ha = app(state, action, view, document.querySelector(".main"));
</script>

