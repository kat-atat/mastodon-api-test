<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>mastodon-api-test</title>
    <script src="../node_modules/dev-kit/dist/dev-kit.js"></script>
  </head>
  <body>
    <dev-kit></dev-kit>
  </body>
</html>



<script type="module">
import APIUtil from "../src/APIUtil.js";
import storage from "../src/storage.js";

const client = {
  id: 0,
  mastodon_url: "",
  client_id: "",
  client_secret: "",
}

const token = {
  client,
  access_token: "",
  token_type: "",
  scope: "",
  created_at: 0,
}

const state = storage.get("STATE") || {
  clients: [],
  tokens: [],
  pending: {
    client: null,
    redirect_uri: new URL(document.location),
    code: "",
  },
  appDetail: {
    client_name: "any-app mastodon",
    website: "http://localhost:8000/",
    scopes: "read write follow",
  },
  mastodon_url: "https://mental.social",
};

state.pending.code = new URL(document.location).searchParams.get("code");

const action = {
  isClientRegistered: ()=> state.clients.filter((client)=> client.mastodon_url === state.mastodon_url).length !== 0,
  hasToken: ()=> state.tokens.filter((token)=> token.client.mastodon_url === state.mastodon_url).length !== 0,
  isPending: ()=> !!(state.pending.client && state.pending.code),
}

console.log("isClientRegistered: " + action.isClientRegistered());
console.log("hasToken: " + action.hasToken());
console.log("isPending: " + action.isPending());

window.run1 = ()=> {

let auth = ()=> {
  let {mastodon_url, client_id} = state.clients.filter((client)=> client.mastodon_url === state.mastodon_url)[0];
  const auth_url = APIUtil.createAuthUrl({
    mastodon_url,
    client_id,
    redirect_uri: state.pending.redirect_uri,
  });
  window.location.href = auth_url;
}

if (action.isClientRegistered() === false) {
  APIUtil.requestApp({
    mastodon_url: state.mastodon_url,
    redirect_uris: state.pending.redirect_uri,
    ...state.appDetail,
  })
  .then(({id, client_id, client_secret})=> {
    let client = {
      id,
      mastodon_url: state.mastodon_url,
      client_id,
      client_secret,
    }
    state.clients.push(client);
    state.pending.client = client;
    storage.set("STATE", state);
    auth();
  });
}

if (action.isClientRegistered() && action.hasToken() === false && action.isPending() === false) {
  let client = state.clients.filter((client)=> client.mastodon_url === state.mastodon_url)[0];
  state.pending.client = client;
  storage.set("STATE", state);
  auth();
}

if (action.hasToken() === false && action.isPending()) {
  let {redirect_uri, code} = state.pending;
  APIUtil.requestToken({...state.pending.client, redirect_uri, code})
  .then(({access_token, token_type, scope, created_at})=> {
    let token = {
      client: state.pending.client,
      access_token,
      token_type,
      scope,
      created_at,
    }
    state.tokens.push(token);
    state.pending.client = null;
    storage.set("STATE", state);
  });
}

}


window.run2 = ()=> {
  console.log(JSON.stringify(state));
}


APIUtil.onresponsed = (responsed)=> {
  console.log(JSON.stringify(responsed));
};
</script>