<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
</head>
<body>
  <script src="../../node_modules/dev-kit/dist/dev-kit.js"></script>
  <dev-kit></dev-kit>
</body>
</html>

<script type="module">
import APIUtil from "../../src/APIUtil.js";
import storage from "../../src/storage.js";

const search = new URL(document.location).searchParams;
const code = search.get("code");
const mastodon_url = search.get("mastodon_url");

(async ()=> {

  if (mastodon_url) {
    const servers = storage.get("servers") || [];
    const server = servers.find((server)=> server.mastodon_url === mastodon_url);
    const registApp_url = new URL("./regist-app.html", location) + `?mastodon_url=${mastodon_url}`;

    if (code && server) {
      let {access_token} = await APIUtil.url(server.mastodon_url)
      .token({
        client_id: server.client_id,
        client_secret: server.client_secret,
        code,
        redirect_uri: server.redirect_uri,
      });
      const main_url = new URL("./main.html", location)
        + `?mastodon_url=${server.mastodon_url}` + `&access_token=${access_token}`;
      location.replace(main_url);
    }

    else if (server) {
      const authLink = APIUtil.url(server.mastodon_url)
      .authLink({
        scope: "read",
        redirect_uri: server.redirect_uri,
        client_id: server.client_id,
      });
      location.replace(authLink);
    }

    else {
      location.replace(registApp_url);
    }
  }

})();
</script>