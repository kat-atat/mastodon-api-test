<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
</head>
<body>
  <script src="../../node_modules/dev-kit/dist/dev-kit.js"></script>
  <dev-kit></dev-kit>
</body>
</html>


<script type="module">
import APIUtil from "../../src/APIUtil.js";
import storage from "../../src/storage.js";

const search = new URL(document.location).searchParams;
const mastodon_url = search.get("mastodon_url");

(async ()=> {

  if (mastodon_url) {
    const servers = storage.get("servers") || [];
    const server = servers.find((server)=> server.mastodon_url === mastodon_url);
    const oauth_url = new URL("./oauth.html", location) + `?mastodon_url=${mastodon_url}`;
    const redirect_uri = oauth_url;

    if (!server) {
      let {client_id, client_secret} = await APIUtil.url(mastodon_url)
      .app({
        client_name: "test",
        scopes: "read write follow",
        redirect_uris: redirect_uri,
        website: "",
      });

      const server = {
        mastodon_url,
        client_id,
        client_secret,
        redirect_uri,
      }

      storage.set("servers", [...servers, server]);
    }

    location.replace(oauth_url);
  }

})();
</script>
